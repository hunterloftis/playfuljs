<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Raycaster Demo - PlayfulJS</title>
  </head>
  <body style='background: #000; margin: 0; padding: 0'>
    <canvas id='display' width='1' height='1' />

    <script>

      function Keyboard() {
        this.codes  = { 37: 'left', 39: 'right', 38: 'forward', 40: 'back' };
        this.states = { 'left': false, 'right': false, 'forward': false, 'back': false };
        document.addEventListener('keydown', this.onKeyDown.bind(this), false);
        document.addEventListener('keyup', this.onKeyUp.bind(this), false);
      }

      Keyboard.prototype.onKeyDown = function(e) {
        var state = this.codes[e.keyCode];
        if (!state) return;
        this.states[state] = true;
        e.preventDefault();
        e.stopPropagation();
      };

      Keyboard.prototype.onKeyUp = function(e) {
        var state = this.codes[e.keyCode];
        if (!state) return;
        this.states[state] = false;
        e.preventDefault();
        e.stopPropagation();
      };
      
      function Player(x, y, direction) {
        this.x = x;
        this.y = y;
        this.direction = direction;
        this.turnSpeed = Math.PI * 2;
        this.walkSpeed = 200;
      }

      Player.prototype.rotate = function(angle) {
        this.direction += angle;
      };

      Player.prototype.walk = function(distance) {
        this.x += distance * Math.cos(this.direction);
        this.y += distance * Math.sin(this.direction);
      };

      Player.prototype.update = function(controls, seconds) {
        if (controls.left) this.rotate(-this.turnSpeed * seconds);
        if (controls.right) this.rotate(this.turnSpeed * seconds);
        if (controls.forward) this.walk(this.walkSpeed * seconds);
        if (controls.backward) this.walk(-this.walkSpeed * seconds);
      };

      Player.prototype.draw = function(ctx, width, height) {
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(width * 0.5 + this.x, height * 0.5 + this.y);
        var x1 = this.x + 20 * Math.cos(this.direction);
        var y1 = this.y + 20 * Math.sin(this.direction);
        ctx.lineTo(width * 0.5 + x1, height * 0.5 + y1);
        ctx.stroke();
      };

      function Wall(x1, y1, x2, y2) {
        this.x1 = x1;
        this.y1 = y1;
        this.x2 = x2;
        this.y2 = y2;
      }

      Wall.prototype.draw = function(ctx, width, height) {
        ctx.strokeStyle = '#00ffff';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(width * 0.5 + this.x1, height * 0.5 + this.y1);
        ctx.lineTo(width * 0.5 + this.x2, height * 0.5 + this.y2);
        ctx.stroke();
      }

      function Raycaster(canvas, resolution) {
        this.ctx = canvas.getContext('2d');
        this.width = canvas.width = window.innerWidth;
        this.height = canvas.height = window.innerHeight;
        this.resolution = resolution;
        this.spacing = this.width / resolution;
      }

      Raycaster.prototype.render = function(player, walls) {
        this.ctx.clearRect(0, 0, this.width, this.height);

        this.ctx.fillStyle = '#ffffff';
        for (var x = 0; x < this.resolution; x++) {
          var distance = 10;
          this.ctx.fillRect(x * this.spacing, this.height * 0.5 - distance, this.spacing + 1, distance * 2);
        }

        // walls.forEach(function(wall) {
        //   wall.draw(this.ctx, this.width, this.height);
        // }.bind(this));
        // player.draw(this.ctx, this.width, this.height);
      };

      var raycaster = new Raycaster(document.getElementById('display'), 640);
      var keyboard = new Keyboard();
      var player = new Player(0, 0, 0);
      var walls = [
        new Wall(-100, -100, 180, -100),
        new Wall(180, -100, 180, -80),
        new Wall(180, -80, 100, -80),
        new Wall(100, -80, 100, 100),
        new Wall(100, 100, -100, 100),
        new Wall(-100, 100, -100, -100),
        new Wall(-50, -80, -50, -50),
        new Wall(-50, -50, -80, -50),
        new Wall(-80, -50, -50, -80)
      ];
      var lastTime = 0;

      requestAnimationFrame(frame);

      function frame(time) {
        var seconds = (time - lastTime) / 1000;
        lastTime = time;
        if (seconds < 0.2) {
          player.update(keyboard.states, seconds);
          raycaster.render(player, walls);
        }
        requestAnimationFrame(frame);
      }

    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-50885475-1', 'playfuljs.com');
      ga('send', 'pageview');
    </script>
  </body>
</html>
